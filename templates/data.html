<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flood Data - Flood Detection & Route Optimization</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/styles.css') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{{ url_for('static', filename='script/script.js') }}" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet for OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Marker Cluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <style>
        #mobile-menu {
            display: none;
        }
    
        #map, #floodMap, #map-container {
            width: 100%;
            height: 500px;
            border-radius: 0.5rem;
        }
    
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
    
        .animate-fade-out {
            animation: fadeOut 0.5s ease-in-out;
        }
    
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    
        /* Loading animations */
        .loading-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Alert styles */
        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
            border-left: 4px solid #059669;
        }
        
        .alert-error {
            background-color: #fee2e2;
            color: #b91c1c;
            border-left: 4px solid #dc2626;
        }
        
        .alert-info {
            background-color: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #2563eb;
        }

        .flood-popup {
            min-width: 200px;
            font-family: 'Inter', sans-serif;
        }

        /* Map legend styles */
        .map-legend { 
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        .legend-icon {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .danger { background-color: #dc2626; }
        .warning { background-color: #ea580c; }
        .normal { background-color: #16a34a; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation Bar -->
    <nav class="flex items-center justify-between px-5 py-3 bg-blue-500 text-white shadow-md">
        <a href="{{ url_for('routes.index') }}">
            <img class="w-32 cursor-pointer" src="{{ url_for('static', filename='img/logo.png') }}" alt="Flood Detection & Route Optimization Logo">
        </a>
        <div class="hidden md:flex space-x-6">
            <a href="{{ url_for('routes.index') }}" class="hover:underline">Home</a>
            <a href="{{ url_for('routes.navigation') }}" class="hover:underline">Navigation</a>
            <a href="{{ url_for('routes.data') }}" class="hover:underline">Flood Data</a>
            <a href="{{ url_for('routes.about') }}" class="hover:underline">About</a>
            <a href="{{ url_for('routes.contact') }}" class="hover:underline">Contact</a>
        </div>
        <div class="md:hidden">
            <button onclick="onToggleMenu()" class="text-2xl">&#9776;</button>
        </div>
    </nav>
    
    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden md:hidden bg-blue-500 text-white p-3 shadow-lg space-y-2">
        <a href="{{ url_for('routes.index') }}" class="block px-2 py-1 hover:underline">Home</a>
        <a href="{{ url_for('routes.navigation') }}" class="block px-2 py-1 hover:underline">Navigation</a>
        <a href="{{ url_for('routes.data') }}" class="block px-2 py-1 hover:underline">Flood Data</a>
        <a href="{{ url_for('routes.about') }}" class="block px-2 py-1 hover:underline">About</a>
        <a href="{{ url_for('routes.contact') }}" class="block px-2 py-1 hover:underline">Contact</a>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto p-4 py-8 space-y-8">
        <!-- Alert Container -->
        <div id="alert-container" class="mb-6"></div>
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="fixed top-4 right-4 bg-white p-3 rounded-lg shadow-md z-50 hidden">
            <div class="flex items-center">
                <i class="fas fa-spinner loading-spinner text-blue-500 mr-2"></i>
                <span>Loading data...</span>
            </div>
        </div>

        <!-- Page Header -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold mb-2">Flood Data & Monitoring</h1>
            <p class="text-gray-600">Real-time flood information, weather conditions, and traffic status for your area.</p>
        </div>

        <!-- Status Indicators -->
        <div class="flex space-x-4 mb-4">
            <div>
                <span class="text-sm font-medium text-gray-700">Server Status:</span>
                <span id="server-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    <svg class="w-2 h-2 mr-1 fill-current" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3"/></svg>
                    Connecting...
                </span>
            </div>
            <div>
                <span class="text-sm font-medium text-gray-700">NodeMCU Status:</span>
                <span id="nodemcu-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    <svg class="w-2 h-2 mr-1 fill-current" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3"/></svg>
                    Checking...
                </span>
            </div>
        </div>

        <!-- Weather and Traffic Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Current Weather Card -->
            <div class="bg-white rounded-lg shadow-md p-5 h-full">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-cloud-sun mr-2 text-blue-500"></i>
                    Current Weather
                </h2>
                <div id="weather-container" class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div id="weather-icon" class="w-16 h-16 mr-4 flex items-center justify-center">
                            <div class="loading-pulse bg-gray-200 rounded-full w-16 h-16"></div>
                        </div>
                        <div>
                            <div id="weather-temp" class="text-3xl font-bold">--Â°C</div>
                            <div id="weather-desc" class="text-gray-600">Loading...</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="weather-location" class="font-medium">Loading...</div>
                        <div id="weather-updated" class="text-sm text-gray-500">Updating...</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 mt-4 text-center">
                    <div class="bg-blue-50 p-2 rounded">
                        <div class="text-sm text-gray-600">Humidity</div>
                        <div id="weather-humidity" class="font-bold">--%</div>
                    </div>
                    <div class="bg-blue-50 p-2 rounded">
                        <div class="text-sm text-gray-600">Wind</div>
                        <div id="weather-wind" class="font-bold">-- km/h</div>
                    </div>
                    <div class="bg-blue-50 p-2 rounded">
                        <div class="text-sm text-gray-600">Rainfall</div>
                        <div id="weather-rain" class="font-bold">-- mm</div>
                    </div>
                </div>
                <div id="weather-alert" class="mt-4 hidden">
                    <!-- Weather alerts will be dynamically inserted here -->
                </div>
            </div>
            
            <!-- Traffic Status Card -->
            <div class="bg-white rounded-lg shadow-md p-5 h-full">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-car mr-2 text-blue-500"></i>
                    Traffic Status
                    <span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full" id="traffic-update-time">Updated: Just now</span>
                </h2>
                <div id="traffic-summary" class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-medium">Overall Traffic Condition:</div>
                        <div id="traffic-condition" class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-800">Moderate</div>
                    </div>
                    <div class="text-sm text-gray-600">
                        Traffic data is updated every 5 minutes for major roads in your area.
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-2 h-2 rounded-full bg-yellow-500 mr-2"></div>
                            <div>Main Avenue</div>
                        </div>
                        <div class="flex items-center">
                            <div class="w-32 bg-gray-200 rounded-full h-2.5 mr-2">
                                <div id="traffic-road1" class="bg-yellow-500 h-2.5 rounded-full" style="width: 65%"></div>
                            </div>
                            <span class="text-xs text-gray-500" id="traffic-road1-value">65%</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-2 h-2 rounded-full bg-red-500 mr-2"></div>
                            <div>Riverside Drive</div>
                        </div>
                        <div class="flex items-center">
                            <div class="w-32 bg-gray-200 rounded-full h-2.5 mr-2">
                                <div id="traffic-road2" class="bg-red-500 h-2.5 rounded-full" style="width: 85%"></div>
                            </div>
                            <span class="text-xs text-gray-500" id="traffic-road2-value">85%</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                            <div>National Highway</div>
                        </div>
                        <div class="flex items-center">
                            <div class="w-32 bg-gray-200 rounded-full h-2.5 mr-2">
                                <div id="traffic-road3" class="bg-green-500 h-2.5 rounded-full" style="width: 30%"></div>
                            </div>
                            <span class="text-xs text-gray-500" id="traffic-road3-value">30%</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-3 border-t border-gray-100">
                    <button id="view-traffic-details" class="text-blue-600 text-sm hover:text-blue-800 transition flex items-center">
                        <i class="fas fa-eye mr-1"></i>
                        View detailed traffic map
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Flood Monitoring Dashboard -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Flood Monitoring Dashboard</h2>
                <button id="refresh-btn" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-200 transition">
                    <i class="fas fa-sync-alt mr-2"></i> Refresh
                </button>
            </div>
            
            <!-- Stats Overview -->
            <div id="flood-stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="text-gray-500 text-sm">Active Nodes</div>
                    <div id="active-nodes" class="text-2xl font-bold">--</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="text-gray-500 text-sm">Highest Reading</div>
                    <div id="highest-reading" class="text-2xl font-bold">--</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="text-gray-500 text-sm">Average Level</div>
                    <div id="average-level" class="text-2xl font-bold">--</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="text-gray-500 text-sm">Last Update</div>
                    <div id="last-update" class="text-2xl font-bold">--</div>
                </div>
            </div>
            
            <!-- Sensor Data Table -->
            <div class="overflow-x-auto mb-6">
                <h3 class="text-lg font-medium mb-3">Latest Sensor Readings</h3>
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left">Node ID</th>
                            <th class="px-4 py-3 text-left">Water Level</th>
                            <th class="px-4 py-3 text-left">Temperature</th>
                            <th class="px-4 py-3 text-left">Humidity</th>
                            <th class="px-4 py-3 text-left">Severity</th>
                            <th class="px-4 py-3 text-left">Status</th>
                            <th class="px-4 py-3 text-left">Last Update</th>
                        </tr>
                    </thead>
                    <tbody id="sensor-data-body" class="divide-y divide-gray-200">
                        <!-- Data will be inserted here by JavaScript -->
                        <tr>
                            <td colspan="7" class="px-4 py-4 text-center text-gray-500">
                                Loading sensor data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Map and Chart Containers -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Map Container -->
                <div class="lg:col-span-2 bg-white rounded-lg shadow p-4">
                    <h3 class="text-lg font-medium mb-3">Sensor Locations</h3>
                    <div id="map-container" style="height: 400px;"></div>
                </div>
                
                <!-- Chart Container -->
                <div class="bg-white rounded-lg shadow p-4">
                    <h3 class="text-lg font-medium mb-3">Trend Analysis</h3>
                    <canvas id="sensor-chart" height="400"></canvas>
                </div>
            </div>

            <!-- Pagination Controls -->
            <div id="pagination-controls" class="flex justify-center items-center gap-4 my-4"></div>
        </div>
        
        <!-- Flood Alerts and Forecast -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Flood Alerts Card -->
            <div class="bg-white rounded-lg shadow-md p-5">
                <h2 class="text-xl font-bold mb-4">Active Flood Alerts</h2>
                <div id="flood-alerts" class="space-y-4">
                    <!-- Alerts will be inserted here by JavaScript -->
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-spinner fa-spin mr-2"></i> Loading alerts...
                    </div>
                </div>
            </div>
            
            <!-- Weather Forecast Card -->
            <div class="bg-white rounded-lg shadow-md p-5">
                <h2 class="text-xl font-bold mb-4">5-Day Forecast</h2>
                <div id="forecast-container" class="grid grid-cols-5 gap-2 text-center">
                    <div class="loading-pulse">
                        <div class="text-sm font-medium">Mon</div>
                        <div class="w-8 h-8 mx-auto my-1 bg-gray-200 rounded-full"></div>
                        <div class="text-sm">--Â°</div>
                    </div>
                    <div class="loading-pulse">
                        <div class="text-sm font-medium">Tue</div>
                        <div class="w-8 h-8 mx-auto my-1 bg-gray-200 rounded-full"></div>
                        <div class="text-sm">--Â°</div>
                    </div>
                    <div class="loading-pulse">
                        <div class="text-sm font-medium">Wed</div>
                        <div class="w-8 h-8 mx-auto my-1 bg-gray-200 rounded-full"></div>
                        <div class="text-sm">--Â°</div>
                    </div>
                    <div class="loading-pulse">
                        <div class="text-sm font-medium">Thu</div>
                        <div class="w-8 h-8 mx-auto my-1 bg-gray-200 rounded-full"></div>
                        <div class="text-sm">--Â°</div>
                    </div>
                    <div class="loading-pulse">
                        <div class="text-sm font-medium">Fri</div>
                        <div class="w-8 h-8 mx-auto my-1 bg-gray-200 rounded-full"></div>
                        <div class="text-sm">--Â°</div>
                    </div>
                </div>
            </div>
            
            <!-- Flood Prediction Card -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h2 class="text-xl font-bold mb-3 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                    Flood Prediction
                </h2>
                <div class="mb-4">
                    <div class="text-sm text-gray-600 mb-2">
                        AI-powered prediction based on current weather, water levels, and historical data.
                    </div>
                    <div id="prediction-confidence" class="flex items-center mb-3">
                        <div class="font-medium mr-2">Prediction Confidence:</div>
                        <div class="w-32 bg-gray-200 rounded-full h-2.5">
                            <div id="confidence-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 85%"></div>
                        </div>
                        <div class="ml-2 text-sm text-gray-600">85%</div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <div>Flood Risk (Next 24h)</div>
                        <div id="flood-risk-24h" class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-800">Moderate</div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>Flood Risk (Next 48h)</div>
                        <div id="flood-risk-48h" class="px-3 py-1 rounded-full bg-red-100 text-red-800">High</div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>Expected Water Level Rise</div>
                        <div id="water-level-prediction" class="text-gray-800">+15cm</div>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-t border-gray-100">
                    <div class="text-sm text-gray-600">
                        <span class="font-medium">Recommendation:</span>
                        <span id="ml-recommendation">Prepare for possible evacuation in low-lying areas.</span>
                    </div>
                </div>
            </div>
        </div>    
        
        <!-- Historical Data and Reporting -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Historical Flood Data -->
            <div class="bg-white rounded-lg shadow-md p-5">
                <h2 class="text-xl font-bold mb-4">Historical Flood Data</h2>
                <div class="mb-4">
                    <canvas id="floodChart" height="200"></canvas>
                </div>
                <div class="text-sm text-gray-600 text-center">
                    Flood water levels over the past 7 days
                </div>
            </div>
            
            <!-- Report Flood -->
            <div class="bg-white rounded-lg shadow-md p-5">
                <h2 class="text-xl font-bold mb-4">Report a Flood</h2>
                <p class="text-gray-600 mb-4">Help your community by reporting flood conditions in your area.</p>
                <form id="floodReportForm" class="space-y-4">
                    <div>
                        <label for="location" class="block text-gray-700 font-medium mb-1">Location</label>
                        <input type="text" id="location" placeholder="Enter street or landmark" 
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="floodLevel" class="block text-gray-700 font-medium mb-1">Flood Level</label>
                        <select id="floodLevel" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="minor">Minor (ankle deep)</option>
                            <option value="moderate">Moderate (knee deep)</option>
                            <option value="severe">Severe (waist deep or higher)</option>
                        </select>
                    </div>
                    <div>
                        <label for="description" class="block text-gray-700 font-medium mb-1">Description (optional)</label>
                        <textarea id="description" rows="3" placeholder="Additional details about the flooding" 
                                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <button type="submit" 
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition font-medium">
                        Submit Report
                    </button>
                </form>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-blue-600 text-white py-4">
        <div class="max-w-4xl mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <h3 class="text-base font-bold mb-2">About Us</h3>
                    <p class="text-blue-100 text-xs">
                        We provide real-time flood detection and route optimization to ensure safer travel during extreme weather conditions.
                    </p>
                </div>
                <div>
                    <h3 class="text-base font-bold mb-2">Quick Links</h3>
                    <ul class="space-y-0.5 text-xs text-blue-100">
                        <li><a href="{{ url_for('routes.index') }}" class="hover:underline">Home</a></li>
                        <li><a href="{{ url_for('routes.about') }}" class="hover:underline">About Us</a></li>
                        <li><a href="{{ url_for('routes.navigation') }}" class="hover:underline">Navigation</a></li>
                        <li><a href="{{ url_for('routes.data') }}" class="hover:underline">Flood Data</a></li>
                    </ul>
                </div>
                <div class="flex flex-col items-start">
                    <h3 class="text-base font-bold mb-2">Connect With Us</h3>
                    <div class="flex space-x-3 text-lg">
                        <a href="#" class="text-white hover:text-gray-300"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="text-white hover:text-gray-300"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-white hover:text-gray-300"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-white hover:text-gray-300"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
            </div>
            <div class="mt-4 text-center text-xs text-blue-100">
                Â© 2025 FloodSafe Navigation. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script>
        // Toggle mobile menu
        function onToggleMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }
    </script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- Flood Detection System Script -->
    <script>
        // Global variables
        let currentPage = 1;
        const itemsPerPage = 10;
        let map;
        let markers;
        let chart;

        // Main function to fetch and display data
        async function fetchAndDisplayData() {
            try {
                showLoading();
                
                // Fetch sensor data
                const sensorResponse = await fetch(`/api/sensor-data?page=${currentPage}&per_page=${itemsPerPage}`);
                const sensorData = await sensorResponse.json();
                
                if (!sensorData.success) {
                    throw new Error(sensorData.error || 'Failed to fetch sensor data');
                }
                
                // Fetch flood alerts
                const alertsResponse = await fetch('/api/flood-alerts');
                const alertsData = await alertsResponse.json();
                
                // Update UI components
                updateSensorTable(sensorData.data);
                updateStats(sensorData.data);
                updatePagination(sensorData.pagination);
                updateFloodAlerts(alertsData);
                
                // Initialize or update map and chart if they exist
                if (document.getElementById('map-container')) {
                    if (!map) initMap();
                    updateMap(sensorData.data);
                }
                
                if (document.getElementById('sensor-chart')) {
                    if (!chart) initChart();
                    updateChart(sensorData.data);
                }
                
            } catch (error) {
                showError(error.message);
            } finally {
                hideLoading();
            }
        }

        // Enhanced table update function
        function updateSensorTable(data) {
            const tbody = document.getElementById('sensor-data-body');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-4 text-center text-gray-500">
                            No sensor data available
                        </td>
                    </tr>`;
                return;
            }
            
            tbody.innerHTML = data.map(sensor => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">${sensor.node_id || 'N/A'}</td>
                    <td class="px-4 py-3">${sensor.water_level ? sensor.water_level + ' cm' : 'N/A'}</td>
                    <td class="px-4 py-3">${sensor.temperature ? sensor.temperature + 'Â°C' : 'N/A'}</td>
                    <td class="px-4 py-3">${sensor.humidity ? sensor.humidity + '%' : 'N/A'}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs ${
                            sensor.severity === 'HIGH' ? 'bg-red-100 text-red-800' :
                            sensor.severity === 'MODERATE' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-green-100 text-green-800'
                        }">
                            ${sensor.severity || 'N/A'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs ${
                            sensor.flood_status ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'
                        }">
                            ${sensor.flood_status ? 'Flooding' : 'Normal'}
                        </span>
                    </td>
                    <td class="px-4 py-3">${sensor.timestamp || 'N/A'}</td>
                </tr>
            `).join('');
        }

        // Enhanced stats update
        function updateStats(data) {
            if (!data || data.length === 0) {
                document.getElementById('active-nodes').textContent = '0';
                document.getElementById('highest-reading').textContent = '0';
                document.getElementById('average-level').textContent = '0';
                document.getElementById('last-update').textContent = 'Never';
                return;
            }
            
            // Calculate stats
            const activeNodes = new Set(data.map(sensor => sensor.node_id)).size;
            
            const waterLevels = data
                .map(sensor => parseFloat(sensor.water_level))
                .filter(level => !isNaN(level));
            
            const highest = waterLevels.length > 0 ? Math.max(...waterLevels) : 0;
            const average = waterLevels.length > 0 ? 
                (waterLevels.reduce((a, b) => a + b, 0) / waterLevels.length) : 0;
            
            // Update UI
            document.getElementById('active-nodes').textContent = activeNodes;
            document.getElementById('highest-reading').textContent = highest.toFixed(1);
            document.getElementById('average-level').textContent = average.toFixed(1);
            
            // Find most recent timestamp
            const latestTimestamp = data.reduce((latest, sensor) => {
                const sensorTime = new Date(sensor.timestamp);
                return sensorTime > latest ? sensorTime : latest;
            }, new Date(0));
            
            document.getElementById('last-update').textContent = 
                latestTimestamp > new Date(0) ? latestTimestamp.toLocaleTimeString() : 'Never';
        }

        // Enhanced flood alerts update
        function updateFloodAlerts(alerts) {
            const container = document.getElementById('flood-alerts');
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = `
                    <div class="alert-info p-3 rounded">
                        No active flood alerts
                    </div>`;
                return;
            }
            
            container.innerHTML = alerts.map(alert => `
                <div class="border-l-4 p-3 rounded ${
                    alert.severity === 'HIGH' ? 'border-red-500 bg-red-50 text-red-700' :
                    alert.severity === 'MODERATE' ? 'border-yellow-500 bg-yellow-50 text-yellow-700' :
                    'border-blue-500 bg-blue-50 text-blue-700'
                }">
                    <div class="font-bold">${alert.title || 'Flood Alert'}</div>
                    <div class="text-sm">${alert.message || 'No details available'}</div>
                    <div class="text-xs text-gray-500">Updated: ${alert.timestamp || 'Unknown'}</div>
                </div>
            `).join('');
        }

        // Pagination controls
        function updatePagination(pagination) {
            const container = document.getElementById('pagination-controls');
            if (!container) return;
            
            container.innerHTML = `
                <button onclick="changePage(1)" class="px-3 py-1 rounded-lg ${currentPage === 1 ? 'bg-gray-200' : 'bg-blue-100 hover:bg-blue-200'}">
                    First
                </button>
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} 
                    class="px-3 py-1 rounded-lg ${currentPage === 1 ? 'bg-gray-200' : 'bg-blue-100 hover:bg-blue-200'}">
                    Previous
                </button>
                <span class="px-3 py-1">
                    Page ${currentPage} of ${pagination.pages}
                </span>
                <button onclick="changePage(${currentPage + 1})" ${currentPage >= pagination.pages ? 'disabled' : ''} 
                    class="px-3 py-1 rounded-lg ${currentPage >= pagination.pages ? 'bg-gray-200' : 'bg-blue-100 hover:bg-blue-200'}">
                    Next
                </button>
                <button onclick="changePage(${pagination.pages})" class="px-3 py-1 rounded-lg ${currentPage === pagination.pages ? 'bg-gray-200' : 'bg-blue-100 hover:bg-blue-200'}">
                    Last
                </button>
            `;
        }

        function changePage(newPage) {
            currentPage = newPage;
            fetchAndDisplayData();
        }

        // Map functions
        function initMap() {
            if (!document.getElementById('map-container')) return;
            
            map = L.map('map-container').setView([14.3435, 121.0807], 13); // Default coordinates
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            markers = L.layerGroup().addTo(map);
            
            // Add legend
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'map-legend');
                div.innerHTML = `
                    <h4 class="font-bold mb-2">Legend</h4>
                    <div class="flex items-center mb-1">
                        <span class="legend-icon danger"></span>
                        <span>Flooding</span>
                    </div>
                    <div class="flex items-center mb-1">
                        <span class="legend-icon warning"></span>
                        <span>High Risk</span>
                    </div>
                    <div class="flex items-center">
                        <span class="legend-icon normal"></span>
                        <span>Normal</span>
                    </div>
                `;
                return div;
            };
            legend.addTo(map);
        }

        function updateMap(data) {
            if (!map || !markers) return;
            
            markers.clearLayers();
            
            data.forEach(sensor => {
                // Use default coordinates if not provided
                const lat = sensor.latitude || 14.3435 + (Math.random() * 0.01 - 0.005);
                const lng = sensor.longitude || 121.0807 + (Math.random() * 0.01 - 0.005);
                
                const markerColor = sensor.flood_status ? 'red' :
                                  sensor.severity === 'HIGH' ? 'orange' : 'green';
                
                const marker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: markerColor,
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                marker.bindPopup(`
                    <div class="flood-popup">
                        <strong>Node ${sensor.node_id}</strong><br>
                        Water Level: ${sensor.water_level} cm<br>
                        Temp: ${sensor.temperature}Â°C<br>
                        Humidity: ${sensor.humidity}%<br>
                        Status: <span class="${sensor.flood_status ? 'text-red-600' : 'text-green-600'}">
                            ${sensor.flood_status ? 'FLOODING' : 'Normal'}
                        </span><br>
                        Last Update: ${sensor.timestamp}
                    </div>
                `);
                
                markers.addLayer(marker);
            });
            
            // Auto-fit map to markers if we have data
            if (data.length > 0) {
                map.fitBounds(markers.getBounds(), {padding: [50, 50]});
            }
        }

        // Chart functions
        function initChart() {
            if (!document.getElementById('sensor-chart')) return;
            
            const ctx = document.getElementById('sensor-chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Water Level (cm)',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Temperature (Â°C)',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    }
                }
            });
        }

        function updateChart(data) {
            if (!chart) return;
            
            // Group data by timestamp
            const timeGroups = {};
            data.forEach(sensor => {
                if (!sensor.timestamp) return;
                
                if (!timeGroups[sensor.timestamp]) {
                    timeGroups[sensor.timestamp] = {
                        waterLevels: [],
                        temperatures: []
                    };
                }
                
                if (sensor.water_level) {
                    timeGroups[sensor.timestamp].waterLevels.push(parseFloat(sensor.water_level));
                }
                
                if (sensor.temperature) {
                    timeGroups[sensor.timestamp].temperatures.push(parseFloat(sensor.temperature));
                }
            });
            
            // Prepare chart data
            const labels = Object.keys(timeGroups);
            const waterData = [];
            const tempData = [];
            
            labels.forEach(time => {
                const group = timeGroups[time];
                
                // Calculate average water level
                const avgWater = group.waterLevels.length > 0 ? 
                    group.waterLevels.reduce((a, b) => a + b, 0) / group.waterLevels.length : null;
                waterData.push(avgWater);
                
                // Calculate average temperature
                const avgTemp = group.temperatures.length > 0 ? 
                    group.temperatures.reduce((a, b) => a + b, 0) / group.temperatures.length : null;
                tempData.push(avgTemp);
            });
            
            // Update chart
            chart.data.labels = labels;
            chart.data.datasets[0].data = waterData;
            chart.data.datasets[1].data = tempData;
            chart.update();
        }

        // Utility functions
        function showLoading() {
            const loader = document.getElementById('loading-indicator');
            if (loader) loader.classList.remove('hidden');
        }

        function hideLoading() {
            const loader = document.getElementById('loading-indicator');
            if (loader) loader.classList.add('hidden');
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            if (errorContainer) {
                errorContainer.querySelector('p').textContent = message;
                errorContainer.classList.remove('hidden');
                setTimeout(() => errorContainer.classList.add('hidden'), 5000);
            }
            console.error(message);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndDisplayData();
            
            // Set up refresh button if it exists
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    currentPage = 1;
                    fetchAndDisplayData();
                });
            }
            
            // Auto-refresh every 30 seconds
            setInterval(fetchAndDisplayData, 30000);
        });

        // Weather Data Fetching
        async function fetchWeatherData() {
            try {
                // Replace with your actual weather API endpoint
                const response = await fetch('https://api.openweathermap.org/data/2.5/weather?q=Bi%C3%B1an,PH&units=metric&appid=305823d8d175b68df2d3b86e973728bf');
                const data = await response.json();
                
                // Update weather display
                document.getElementById('weather-temp').textContent = `${Math.round(data.main.temp)}Â°C`;
                document.getElementById('weather-desc').textContent = data.weather[0].description;
                document.getElementById('weather-humidity').textContent = `${data.main.humidity}%`;
                document.getElementById('weather-wind').textContent = `${(data.wind.speed * 3.6).toFixed(1)} km/h`;
                document.getElementById('weather-rain').textContent = data.rain ? `${data.rain['1h']} mm` : '0 mm';
                document.getElementById('weather-updated').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
                document.getElementById('weather-location').textContent = data.name || 'BiÃ±an City';
                
                // Set weather icon
                const iconCode = data.weather[0].icon;
                document.getElementById('weather-icon').innerHTML = `
                    <img src="https://openweathermap.org/img/wn/${iconCode}@2x.png" alt="${data.weather[0].description}">`;
                
                // Update forecast
                updateWeatherForecast();
                
            } catch (error) {
                console.error('Error fetching weather data:', error);
                document.getElementById('weather-desc').textContent = 'Weather data unavailable';
            }
        }

        // Function to update 5-day forecast
        async function updateWeatherForecast() {
            try {
                // Replace with your actual forecast API endpoint
                const response = await fetch('https://api.openweathermap.org/data/2.5/forecast?q=Bi%C3%B1an,PH&units=metric&appid=305823d8d175b68df2d3b86e973728bf');
                const data = await response.json();
                
                // Process forecast data (get one reading per day)
                const dailyForecasts = [];
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                
                data.list.forEach(forecast => {
                    const date = new Date(forecast.dt * 1000);
                    const day = date.getDay();
                    const hour = date.getHours();
                    
                    // Use noon forecast for each day
                    if (hour === 12 && !dailyForecasts[day]) {
                        dailyForecasts[day] = {
                            day: days[day],
                            temp: Math.round(forecast.main.temp),
                            icon: forecast.weather[0].icon,
                            description: forecast.weather[0].main
                        };
                    }
                });
                
                // Update forecast display
                const forecastContainer = document.getElementById('forecast-container');
                forecastContainer.innerHTML = dailyForecasts.slice(0, 5).map(day => `
                    <div class="animate-fade-in">
                        <div class="text-sm font-medium">${day.day}</div>
                        <img src="https://openweathermap.org/img/wn/${day.icon}.png" class="w-8 h-8 mx-auto my-1" alt="${day.description}">
                        <div class="text-sm">${day.temp}Â°</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error fetching forecast:', error);
            }
        }

        // Initial weather data fetch
        fetchWeatherData();
        
        // Refresh weather every 15 minutes
        setInterval(fetchWeatherData, 15 * 60 * 1000);

        // Form Submission Handler
        document.getElementById('floodReportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form values
            const location = document.getElementById('location').value;
            const floodLevel = document.getElementById('floodLevel').value;
            const description = document.getElementById('description').value;
            
            // Here you would typically send this data to your backend
            console.log('Flood Report Submitted:', { location, floodLevel, description });
            
            // Show confirmation (in a real app, this would be more sophisticated)
            alert('Thank you for your flood report! Authorities have been notified.');
            
            // Reset form
            this.reset();
        });

        // Historical flood data chart
        const ctx = document.getElementById('floodChart').getContext('2d');
        const floodChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Water Level (cm)',
                    data: [120, 190, 170, 210, 240, 180, 150],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Water Level (cm)'
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
